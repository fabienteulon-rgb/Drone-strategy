<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#121212">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Drone Strike Ops</title>
    <link rel="manifest" id="manifest-placeholder">
    <!-- RETOUR À LA VERSION STABLE r128 POUR ÉVITER LES ERREURS DE CHARGEMENT -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
        /* --- UI MOBILE OPTIMISÉE --- */
        body { margin: 0; overflow: hidden; background: #121212; font-family: 'Courier New', Courier, monospace; touch-action: none; user-select: none; -webkit-user-select: none; }
        
        #game-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; }
        
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 2; pointer-events: none; }
        
        /* HUD HAUT */
        .hud-top { position: absolute; top: 10px; left: 10px; right: 10px; display: flex; justify-content: space-between; color: #00ffcc; text-shadow: 0 0 5px rgba(0, 255, 204, 0.5); font-weight: bold; font-size: 14px; pointer-events: none;}
        .hud-box { background: rgba(0, 20, 10, 0.6); padding: 5px 10px; border: 1px solid #00ffcc; border-radius: 4px; }
        
        /* CONTROLS BAS */
        .controls-area { position: absolute; bottom: 20px; width: 100%; height: 150px; display: flex; justify-content: space-between; align-items: flex-end; padding: 0 20px; box-sizing: border-box; pointer-events: none; }
        
        /* JOYSTICK ZONE */
        #joystick-zone { width: 120px; height: 120px; position: relative; pointer-events: auto; }
        .joystick-base { width: 100%; height: 100%; background: rgba(255, 255, 255, 0.1); border: 2px solid rgba(255, 255, 255, 0.3); border-radius: 50%; position: absolute; top: 0; left: 0; }
        .joystick-stick { width: 50px; height: 50px; background: rgba(0, 255, 204, 0.5); border-radius: 50%; position: absolute; top: 35px; left: 35px; box-shadow: 0 0 10px #00ffcc; transition: transform 0.1s; }

        /* ACTION BUTTONS */
        #action-zone { pointer-events: auto; display: flex; gap: 15px; }
        .btn-action { width: 80px; height: 80px; border-radius: 50%; border: 2px solid #ff3300; background: rgba(50, 10, 0, 0.6); color: #ff3300; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 14px; box-shadow: 0 0 15px rgba(255, 51, 0, 0.3); transition: transform 0.1s; text-transform: uppercase; cursor: pointer; }
        .btn-action:active { transform: scale(0.9); background: rgba(255, 51, 0, 0.3); }

        /* MESSAGES */
        #msg-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 10; display: none; }
        .msg-content { color: white; text-align: center; border: 2px solid #00ffcc; padding: 30px; background: rgba(0, 50, 50, 0.8); box-shadow: 0 0 30px rgba(0, 255, 204, 0.4); max-width: 80%; }
        button.restart-btn { margin-top: 20px; padding: 15px 30px; background: #00ffcc; border: none; font-weight: bold; font-size: 18px; color: black; cursor: pointer; }
    </style>
</head>
<body>

    <!-- UI LAYER -->
    <div id="ui-layer">
        <div class="hud-top">
            <div class="hud-box">BATTERIE: <span id="fuel">100</span>%</div>
            <div class="hud-box">CIBLES: <span id="targets">0</span></div>
        </div>

        <div class="controls-area">
            <!-- Zone Joystick Gauche -->
            <div id="joystick-zone">
                <div class="joystick-base"></div>
                <div class="joystick-stick" id="stick"></div>
            </div>

            <!-- Boutons Droite -->
            <div id="action-zone">
                <div class="btn-action" id="btn-fire" style="border-color: #ff3300; color: #ff3300;">LARGUE</div>
            </div>
        </div>
    </div>

    <!-- MESSAGES -->
    <div id="msg-overlay">
        <div class="msg-content">
            <h1 id="msg-title">MISSION ACCOMPLIE</h1>
            <p id="msg-text">Zone sécurisée. Retour à la base.</p>
            <button class="restart-btn" onclick="location.reload()">REJOUER</button>
        </div>
    </div>

    <script>
        // --- 1. CONFIGURATION PWA ---
        const manifest = {
            "name": "Drone Ops 3D",
            "short_name": "DroneOps",
            "start_url": ".",
            "display": "standalone",
            "orientation": "landscape",
            "background_color": "#121212",
            "theme_color": "#121212",
            "icons": [{ "src": "https://via.placeholder.com/192/00ffcc/000000?text=DRONE", "sizes": "192x192", "type": "image/png" }]
        };
        document.getElementById('manifest-placeholder').setAttribute('href', URL.createObjectURL(new Blob([JSON.stringify(manifest)], {type: 'application/json'})));

        // --- 2. CONFIGURATION GAMEPLAY ---
        const SETTINGS = {
            speed: 0.15,
            inertia: 0.92,
            tilt: 0.3,
            camSmooth: 0.1
        };

        let gameState = {
            active: true,
            fuel: 100,
            targetsLeft: 0,
            velocity: { x: 0, z: 0 },
            input: { x: 0, y: 0 }
        };

        // Fonction d'initialisation pour garantir que THREE est chargé
        function initGame() {
            if (typeof THREE === 'undefined') {
                console.error("Three.js not loaded");
                return;
            }

            // --- 3. THREE.JS SETUP ---
            const scene = new THREE.Scene();
            scene.background = new THREE.Color(0x101015);
            scene.fog = new THREE.Fog(0x101015, 15, 45);

            // Caméra isométrique
            const aspect = window.innerWidth / window.innerHeight;
            const d = 12;
            const camera = new THREE.OrthographicCamera(-d * aspect, d * aspect, d, -d, 1, 1000);
            camera.position.set(20, 20, 20);
            camera.lookAt(0, 0, 0);

            const renderer = new THREE.WebGLRenderer({ antialias: true, powerPreference: "high-performance" });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.shadowMap.enabled = true;
            renderer.shadowMap.type = THREE.PCFSoftShadowMap;
            document.body.appendChild(renderer.domElement);

            // Lumière
            const ambient = new THREE.AmbientLight(0xffffff, 0.4);
            scene.add(ambient);
            const sun = new THREE.DirectionalLight(0xffffff, 0.8);
            sun.position.set(10, 20, 10);
            sun.castShadow = true;
            sun.shadow.mapSize.width = 1024;
            sun.shadow.mapSize.height = 1024;
            scene.add(sun);

            // --- 4. OBJETS DU JEU ---
            
            // SOL
            const floorGeo = new THREE.PlaneGeometry(100, 100);
            const floorMat = new THREE.MeshStandardMaterial({ color: 0x2a2a2e, roughness: 0.8 });
            const floor = new THREE.Mesh(floorGeo, floorMat);
            floor.rotation.x = -Math.PI / 2;
            floor.receiveShadow = true;
            scene.add(floor);

            // DÉCOR
            const obsGeo = new THREE.BoxGeometry(1,1,1);
            const obsMat = new THREE.MeshStandardMaterial({color: 0x444444});
            for(let i=0; i<15; i++) {
                const b = new THREE.Mesh(obsGeo, obsMat);
                const h = Math.random() * 3 + 1;
                b.scale.set(Math.random()*2+1, h, Math.random()*2+1);
                b.position.set(Math.random()*30-15, h/2, Math.random()*30-15);
                b.castShadow = true;
                b.receiveShadow = true;
                scene.add(b);
            }

            // DRONE
            const droneGroup = new THREE.Group();
            const body = new THREE.Mesh(new THREE.BoxGeometry(0.8, 0.2, 0.8), new THREE.MeshPhongMaterial({color: 0x222222}));
            body.castShadow = true;
            droneGroup.add(body);
            const armGeo = new THREE.BoxGeometry(1.6, 0.05, 0.1);
            const arm1 = new THREE.Mesh(armGeo, new THREE.MeshPhongMaterial({color: 0x555555}));
            const arm2 = arm1.clone();
            arm2.rotation.y = Math.PI / 2;
            droneGroup.add(arm1);
            droneGroup.add(arm2);
            const lightL = new THREE.PointLight(0x00ffcc, 1, 5);
            lightL.position.set(0, -0.5, 0);
            droneGroup.add(lightL);
            droneGroup.position.set(0, 5, 0);
            scene.add(droneGroup);

            // RETICLE
            const reticleGeo = new THREE.RingGeometry(0.4, 0.5, 32);
            const reticleMat = new THREE.MeshBasicMaterial({ color: 0xff3300, transparent: true, opacity: 0.7, side: THREE.DoubleSide });
            const reticle = new THREE.Mesh(reticleGeo, reticleMat);
            reticle.rotation.x = -Math.PI / 2;
            reticle.position.y = 0.05;
            scene.add(reticle);

            // CIBLES (Correction: Remplacement de CapsuleGeometry par CylinderGeometry pour compatibilité r128)
            let targets = [];
            // CylinderGeometry(radiusTop, radiusBottom, height, radialSegments)
            const targetGeo = new THREE.CylinderGeometry(0.25, 0.25, 0.8, 8); 
            const targetMat = new THREE.MeshPhongMaterial({color: 0xff3333});
            
            function spawnTargets(count) {
                gameState.targetsLeft = count;
                document.getElementById('targets').innerText = count;
                for(let i=0; i<count; i++) {
                    const t = new THREE.Mesh(targetGeo, targetMat);
                    t.position.set(Math.random()*20-10, 0.65, Math.random()*20-10);
                    t.castShadow = true;
                    t.userData = { speed: Math.random() * 0.02 + 0.01, dir: Math.random() * Math.PI * 2 };
                    scene.add(t);
                    targets.push(t);
                }
            }
            spawnTargets(5);

            // PROJECTILES
            let bombs = [];
            const bombGeo = new THREE.SphereGeometry(0.15, 8, 8);
            const bombMat = new THREE.MeshBasicMaterial({color: 0xffff00});

            // INPUTS
            const joystickZone = document.getElementById('joystick-zone');
            const stick = document.getElementById('stick');
            let stickData = { startX: 0, startY: 0, active: false };

            joystickZone.addEventListener('touchstart', (e) => {
                e.preventDefault();
                const touch = e.changedTouches[0];
                stickData.startX = touch.clientX;
                stickData.startY = touch.clientY;
                stickData.active = true;
            }, {passive: false});

            joystickZone.addEventListener('touchmove', (e) => {
                if(!stickData.active) return;
                e.preventDefault();
                const touch = e.changedTouches[0];
                
                let dx = touch.clientX - stickData.startX;
                let dy = touch.clientY - stickData.startY;
                
                const maxDist = 35;
                const distance = Math.min(Math.sqrt(dx*dx + dy*dy), maxDist);
                const angle = Math.atan2(dy, dx);
                
                const clampedX = Math.cos(angle) * distance;
                const clampedY = Math.sin(angle) * distance;

                stick.style.transform = `translate(${clampedX}px, ${clampedY}px)`;

                gameState.input.x = clampedX / maxDist;
                gameState.input.y = clampedY / maxDist;
            }, {passive: false});

            const resetJoystick = () => {
                stickData.active = false;
                stick.style.transform = `translate(0px, 0px)`;
                gameState.input.x = 0;
                gameState.input.y = 0;
            };
            joystickZone.addEventListener('touchend', resetJoystick);
            joystickZone.addEventListener('touchcancel', resetJoystick);

            document.getElementById('btn-fire').addEventListener('touchstart', (e) => {
                e.preventDefault();
                dropBomb();
                document.getElementById('btn-fire').style.transform = "scale(0.9)";
            });
            document.getElementById('btn-fire').addEventListener('touchend', (e) => {
                document.getElementById('btn-fire').style.transform = "scale(1)";
            });

            // LOGIQUE
            function dropBomb() {
                if(!gameState.active) return;
                const b = new THREE.Mesh(bombGeo, bombMat);
                b.position.copy(droneGroup.position);
                b.position.y -= 0.5;
                scene.add(b);
                bombs.push({ mesh: b, vy: 0 });
            }

            function createExplosion(pos) {
                const flash = new THREE.PointLight(0xffaa00, 2, 5);
                flash.position.copy(pos);
                flash.position.y = 1;
                scene.add(flash);
                setTimeout(() => scene.remove(flash), 100);

                if (navigator.vibrate) navigator.vibrate(50);

                for(let i = targets.length - 1; i >= 0; i--) {
                    const t = targets[i];
                    const dist = new THREE.Vector2(pos.x, pos.z).distanceTo(new THREE.Vector2(t.position.x, t.position.z));
                    if(dist < 1.5) {
                        scene.remove(t);
                        targets.splice(i, 1);
                        gameState.targetsLeft--;
                        document.getElementById('targets').innerText = gameState.targetsLeft;
                        if(navigator.vibrate) navigator.vibrate([50, 50, 50]);
                    }
                }

                if(gameState.targetsLeft === 0) gameOver(true);
            }

            function gameOver(win) {
                gameState.active = false;
                document.getElementById('msg-overlay').style.display = 'flex';
                document.getElementById('msg-title').innerText = win ? "MISSION ACCOMPLIE" : "ECHEC MISSION";
                document.getElementById('msg-title').style.color = win ? "#00ffcc" : "#ff3300";
            }

            function animate() {
                requestAnimationFrame(animate);

                if(gameState.active) {
                    gameState.velocity.x += gameState.input.x * SETTINGS.speed * 0.1;
                    gameState.velocity.z += gameState.input.y * SETTINGS.speed * 0.1;
                    
                    gameState.velocity.x *= SETTINGS.inertia;
                    gameState.velocity.z *= SETTINGS.inertia;

                    droneGroup.position.x += gameState.velocity.x;
                    droneGroup.position.z += gameState.velocity.z;

                    droneGroup.rotation.z = -gameState.velocity.x * 2;
                    droneGroup.rotation.x = gameState.velocity.z * 2;

                    droneGroup.position.x = THREE.MathUtils.clamp(droneGroup.position.x, -40, 40);
                    droneGroup.position.z = THREE.MathUtils.clamp(droneGroup.position.z, -40, 40);

                    reticle.position.x = droneGroup.position.x;
                    reticle.position.z = droneGroup.position.z;
                    reticle.rotation.z += 0.02;

                    const targetCamX = droneGroup.position.x + 20;
                    const targetCamZ = droneGroup.position.z + 20;
                    camera.position.x += (targetCamX - camera.position.x) * SETTINGS.camSmooth;
                    camera.position.z += (targetCamZ - camera.position.z) * SETTINGS.camSmooth;
                    camera.lookAt(droneGroup.position.x, 0, droneGroup.position.z);

                    for(let i = bombs.length - 1; i >= 0; i--) {
                        const b = bombs[i];
                        b.vy -= 0.02;
                        b.mesh.position.y += b.vy;
                        if(b.mesh.position.y <= 0) {
                            createExplosion(b.mesh.position);
                            scene.remove(b.mesh);
                            bombs.splice(i, 1);
                        }
                    }

                    targets.forEach(t => {
                        t.position.x += Math.cos(t.userData.dir) * t.userData.speed;
                        t.position.z += Math.sin(t.userData.dir) * t.userData.speed;
                        if(Math.abs(t.position.x) > 15 || Math.abs(t.position.z) > 15) {
                            t.userData.dir += Math.PI;
                        }
                    });
                }
                renderer.render(scene, camera);
            }

            window.addEventListener('resize', () => {
                const aspect = window.innerWidth / window.innerHeight;
                const d = 12;
                camera.left = -d * aspect;
                camera.right = d * aspect;
                camera.top = d;
                camera.bottom = -d;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
            });

            animate();
        }

        // Lancement sécurisé
        window.addEventListener('load', initGame);

        // Service Worker
        if ('serviceWorker' in navigator) {
            const swCode = `
                const CACHE_NAME = 'drone-ops-v1';
                self.addEventListener('install', e => e.waitUntil(caches.open(CACHE_NAME).then(c => c.addAll(['./']))));
                self.addEventListener('fetch', e => e.respondWith(caches.match(e.request).then(r => r || fetch(e.request))));
            `;
            navigator.serviceWorker.register(URL.createObjectURL(new Blob([swCode], {type: 'application/javascript'})));
        }
    </script>
</body>
</html>
