<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#121212">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Drone Strike Ops</title>
    <!-- Chargement de Three.js r128 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
        body { margin: 0; overflow: hidden; background: #121212; font-family: 'Courier New', Courier, monospace; touch-action: none; user-select: none; -webkit-user-select: none; }
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 2; pointer-events: none; }
        .hud-top { position: absolute; top: 10px; left: 10px; right: 10px; display: flex; justify-content: space-between; color: #00ffcc; text-shadow: 0 0 5px rgba(0, 255, 204, 0.5); font-weight: bold; font-size: 14px; }
        .hud-box { background: rgba(0, 20, 10, 0.6); padding: 5px 10px; border: 1px solid #00ffcc; border-radius: 4px; }
        .controls-area { position: absolute; bottom: 20px; width: 100%; height: 150px; display: flex; justify-content: space-between; align-items: flex-end; padding: 0 20px; box-sizing: border-box; }
        #joystick-zone { width: 120px; height: 120px; position: relative; pointer-events: auto; cursor: crosshair; }
        .joystick-base { width: 100%; height: 100%; background: rgba(255, 255, 255, 0.1); border: 2px solid rgba(255, 255, 255, 0.3); border-radius: 50%; position: absolute; top: 0; left: 0; }
        .joystick-stick { width: 50px; height: 50px; background: rgba(0, 255, 204, 0.5); border-radius: 50%; position: absolute; top: 35px; left: 35px; box-shadow: 0 0 10px #00ffcc; transition: transform 0.1s; }
        #action-zone { pointer-events: auto; display: flex; gap: 15px; }
        .btn-action { width: 80px; height: 80px; border-radius: 50%; border: 2px solid #ff3300; background: rgba(50, 10, 0, 0.6); color: #ff3300; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 14px; box-shadow: 0 0 15px rgba(255, 51, 0, 0.3); transition: transform 0.1s; text-transform: uppercase; cursor: pointer; }
        .btn-action:active { transform: scale(0.9); background: rgba(255, 51, 0, 0.3); }
        #pc-hint { display: none; position: absolute; bottom: 10px; width: 100%; text-align: center; color: rgba(255,255,255,0.3); font-size: 10px; }
        #msg-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 10; display: none; pointer-events: auto; }
        .msg-content { color: white; text-align: center; border: 2px solid #00ffcc; padding: 30px; background: rgba(0, 50, 50, 0.8); box-shadow: 0 0 30px rgba(0, 255, 204, 0.4); max-width: 80%; }
        button.restart-btn { margin-top: 20px; padding: 15px 30px; background: #00ffcc; border: none; font-weight: bold; font-size: 18px; color: black; cursor: pointer; }
    </style>
</head>
<body>

    <div id="ui-layer">
        <div class="hud-top">
            <div class="hud-box">BATTERIE: <span id="fuel">100</span>%</div>
            <div class="hud-box">CIBLES: <span id="targets">0</span></div>
        </div>

        <div class="controls-area">
            <div id="joystick-zone">
                <div class="joystick-base"></div>
                <div class="joystick-stick" id="stick"></div>
            </div>
            <div id="action-zone">
                <div class="btn-action" id="btn-fire">LARGUE</div>
            </div>
        </div>
        <div id="pc-hint">PC: FLÈCHES/ZQSD pour bouger, ESPACE pour tirer</div>
    </div>

    <div id="msg-overlay">
        <div class="msg-content">
            <h1 id="msg-title">MISSION ACCOMPLIE</h1>
            <p id="msg-text">Zone sécurisée. Retour à la base.</p>
            <button class="restart-btn" onclick="location.reload()">REJOUER</button>
        </div>
    </div>

    <script>
        const SETTINGS = { speed: 0.15, inertia: 0.92, tilt: 0.3, camSmooth: 0.1 };
        let gameState = { active: true, fuel: 100, targetsLeft: 0, velocity: { x: 0, z: 0 }, input: { x: 0, y: 0 } };

        if (!('ontouchstart' in window)) {
            document.getElementById('pc-hint').style.display = 'block';
        }

        function initGame() {
            if (typeof THREE === 'undefined') return;

            const scene = new THREE.Scene();
            scene.background = new THREE.Color(0x101015);
            scene.fog = new THREE.Fog(0x101015, 15, 45);

            const aspect = window.innerWidth / window.innerHeight;
            const d = 12;
            const camera = new THREE.OrthographicCamera(-d * aspect, d * aspect, d, -d, 1, 1000);
            camera.position.set(20, 20, 20);
            camera.lookAt(0, 0, 0);

            const renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.shadowMap.enabled = true;
            document.body.appendChild(renderer.domElement);

            const ambient = new THREE.AmbientLight(0xffffff, 0.4);
            scene.add(ambient);
            const sun = new THREE.DirectionalLight(0xffffff, 0.8);
            sun.position.set(10, 20, 10);
            sun.castShadow = true;
            scene.add(sun);

            const floor = new THREE.Mesh(new THREE.PlaneGeometry(100, 100), new THREE.MeshStandardMaterial({ color: 0x2a2a2e }));
            floor.rotation.x = -Math.PI / 2;
            floor.receiveShadow = true;
            scene.add(floor);

            for(let i=0; i<15; i++) {
                const h = Math.random() * 3 + 1;
                const b = new THREE.Mesh(new THREE.BoxGeometry(1,1,1), new THREE.MeshStandardMaterial({color: 0x444444}));
                b.scale.set(Math.random()*2+1, h, Math.random()*2+1);
                b.position.set(Math.random()*30-15, h/2, Math.random()*30-15);
                b.castShadow = true;
                b.receiveShadow = true;
                scene.add(b);
            }

            const droneGroup = new THREE.Group();
            const body = new THREE.Mesh(new THREE.BoxGeometry(0.8, 0.2, 0.8), new THREE.MeshPhongMaterial({color: 0x222222}));
            body.castShadow = true;
            droneGroup.add(body);
            const arm1 = new THREE.Mesh(new THREE.BoxGeometry(1.6, 0.05, 0.1), new THREE.MeshPhongMaterial({color: 0x555555}));
            const arm2 = arm1.clone(); arm2.rotation.y = Math.PI/2;
            droneGroup.add(arm1); droneGroup.add(arm2);
            droneGroup.position.set(0, 5, 0);
            scene.add(droneGroup);

            const reticle = new THREE.Mesh(new THREE.RingGeometry(0.4, 0.5, 32), new THREE.MeshBasicMaterial({ color: 0xff3300, transparent: true, opacity: 0.7, side: THREE.DoubleSide }));
            reticle.rotation.x = -Math.PI / 2;
            reticle.position.y = 0.05;
            scene.add(reticle);

            let targets = [];
            const targetGeo = new THREE.CylinderGeometry(0.25, 0.25, 0.8, 8); 
            const targetMat = new THREE.MeshPhongMaterial({color: 0xff3333});
            
            function spawnTargets(count) {
                gameState.targetsLeft = count;
                document.getElementById('targets').innerText = count;
                for(let i=0; i<count; i++) {
                    const t = new THREE.Mesh(targetGeo, targetMat);
                    t.position.set(Math.random()*20-10, 0.65, Math.random()*20-10);
                    t.castShadow = true;
                    t.userData = { speed: Math.random() * 0.02 + 0.01, dir: Math.random() * Math.PI * 2 };
                    scene.add(t);
                    targets.push(t);
                }
            }
            spawnTargets(5);

            let bombs = [];
            const bombGeo = new THREE.SphereGeometry(0.15, 8, 8);
            const bombMat = new THREE.MeshBasicMaterial({color: 0xffff00});

            const joystickZone = document.getElementById('joystick-zone');
            const stick = document.getElementById('stick');
            let stickData = { startX: 0, startY: 0, active: false };

            function handleStickStart(x, y) { stickData.startX = x; stickData.startY = y; stickData.active = true; }
            function handleStickMove(x, y) {
                if(!stickData.active) return;
                let dx = x - stickData.startX;
                let dy = y - stickData.startY;
                const maxDist = 35;
                const distance = Math.min(Math.sqrt(dx*dx + dy*dy), maxDist);
                const angle = Math.atan2(dy, dx);
                const clampedX = Math.cos(angle) * distance;
                const clampedY = Math.sin(angle) * distance;
                stick.style.transform = `translate(${clampedX}px, ${clampedY}px)`;
                gameState.input.x = clampedX / maxDist;
                gameState.input.y = clampedY / maxDist;
            }
            function handleStickEnd() {
                stickData.active = false;
                stick.style.transform = `translate(0px, 0px)`;
                if (!Object.values(keysPressed).some(v => v)) { gameState.input.x = 0; gameState.input.y = 0; }
            }

            joystickZone.addEventListener('touchstart', e => { e.preventDefault(); handleStickStart(e.touches[0].clientX, e.touches[0].clientY); }, {passive:false});
            window.addEventListener('touchmove', e => { if(stickData.active) handleStickMove(e.touches[0].clientX, e.touches[0].clientY); }, {passive:false});
            window.addEventListener('touchend', handleStickEnd);

            joystickZone.addEventListener('mousedown', e => handleStickStart(e.clientX, e.clientY));
            window.addEventListener('mousemove', e => handleStickMove(e.clientX, e.clientY));
            window.addEventListener('mouseup', handleStickEnd);

            const btnFire = document.getElementById('btn-fire');
            function fire() { dropBomb(); btnFire.style.transform = "scale(0.9)"; setTimeout(()=>btnFire.style.transform="scale(1)", 100); }
            btnFire.addEventListener('touchstart', e => { e.preventDefault(); fire(); });
            btnFire.addEventListener('mousedown', fire);

            let keysPressed = { up: false, down: false, left: false, right: false };
            window.addEventListener('keydown', e => {
                if(!gameState.active) return;
                if(e.code==='ArrowUp'||e.code==='KeyW'||e.code==='KeyZ') keysPressed.up = true;
                if(e.code==='ArrowDown'||e.code==='KeyS') keysPressed.down = true;
                if(e.code==='ArrowLeft'||e.code==='KeyA'||e.code==='KeyQ') keysPressed.left = true;
                if(e.code==='ArrowRight'||e.code==='KeyD') keysPressed.right = true;
                if(e.code==='Space') fire();
                updateKeys();
            });
            window.addEventListener('keyup', e => {
                if(e.code==='ArrowUp'||e.code==='KeyW'||e.code==='KeyZ') keysPressed.up = false;
                if(e.code==='ArrowDown'||e.code==='KeyS') keysPressed.down = false;
                if(e.code==='ArrowLeft'||e.code==='KeyA'||e.code==='KeyQ') keysPressed.left = false;
                if(e.code==='ArrowRight'||e.code==='KeyD') keysPressed.right = false;
                updateKeys();
            });
            function updateKeys() {
                if(stickData.active) return;
                let x = 0, y = 0;
                if(keysPressed.up) y -= 1; if(keysPressed.down) y += 1;
                if(keysPressed.left) x -= 1; if(keysPressed.right) x += 1;
                gameState.input.x = x; gameState.input.y = y;
            }

            function dropBomb() {
                if(!gameState.active) return;
                const b = new THREE.Mesh(bombGeo, bombMat);
                b.position.copy(droneGroup.position);
                scene.add(b);
                bombs.push({ mesh: b, vy: 0 });
            }

            function explode(pos) {
                const flash = new THREE.PointLight(0xffaa00, 2, 5);
                flash.position.copy(pos); scene.add(flash);
                setTimeout(() => scene.remove(flash), 100);
                for(let i = targets.length - 1; i >= 0; i--) {
                    if(new THREE.Vector2(pos.x, pos.z).distanceTo(new THREE.Vector2(targets[i].position.x, targets[i].position.z)) < 1.5) {
                        scene.remove(targets[i]); targets.splice(i, 1);
                        gameState.targetsLeft--;
                        document.getElementById('targets').innerText = gameState.targetsLeft;
                    }
                }
                if(gameState.targetsLeft === 0) gameOver(true);
            }

            function gameOver(win) {
                gameState.active = false;
                document.getElementById('msg-overlay').style.display = 'flex';
                document.getElementById('msg-title').innerText = win ? "MISSION ACCOMPLIE" : "ECHEC";
            }

            function animate() {
                requestAnimationFrame(animate);
                if(gameState.active) {
                    gameState.velocity.x = (gameState.velocity.x + gameState.input.x * SETTINGS.speed * 0.1) * SETTINGS.inertia;
                    gameState.velocity.z = (gameState.velocity.z + gameState.input.y * SETTINGS.speed * 0.1) * SETTINGS.inertia;
                    droneGroup.position.x += gameState.velocity.x;
                    droneGroup.position.z += gameState.velocity.z;
                    droneGroup.rotation.z = -gameState.velocity.x * 2;
                    droneGroup.rotation.x = gameState.velocity.z * 2;
                    reticle.position.x = droneGroup.position.x;
                    reticle.position.z = droneGroup.position.z;
                    camera.position.x += (droneGroup.position.x + 20 - camera.position.x) * SETTINGS.camSmooth;
                    camera.position.z += (droneGroup.position.z + 20 - camera.position.z) * SETTINGS.camSmooth;
                    camera.lookAt(droneGroup.position.x, 0, droneGroup.position.z);
                    for(let i = bombs.length - 1; i >= 0; i--) {
                        bombs[i].vy -= 0.02; bombs[i].mesh.position.y += bombs[i].vy;
                        if(bombs[i].mesh.position.y <= 0) { explode(bombs[i].mesh.position); scene.remove(bombs[i].mesh); bombs.splice(i, 1); }
                    }
                    targets.forEach(t => {
                        t.position.x += Math.cos(t.userData.dir) * t.userData.speed;
                        t.position.z += Math.sin(t.userData.dir) * t.userData.speed;
                        if(Math.abs(t.position.x) > 15 || Math.abs(t.position.z) > 15) t.userData.dir += Math.PI;
                    });
                }
                renderer.render(scene, camera);
            }
            window.addEventListener('resize', () => {
                const aspect = window.innerWidth / window.innerHeight;
                camera.left = -d * aspect; camera.right = d * aspect;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
            });
            animate();
        }
        window.onload = initGame;
    </script>
</body>
</html>
